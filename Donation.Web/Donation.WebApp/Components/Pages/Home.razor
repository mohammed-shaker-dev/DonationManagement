@page "/"
@rendermode InteractiveServer
@using Dashboard.Core.DTOs
@using Dashboard.Core.ProjectAggregate
@using Donation.Web.Services
@using Donation.Web.Components.Pages
@using SharedKernel.Enums

@inject DonationService DonationService
@inject IJSRuntime JS
@inject ProjectServicePublic ProjectService

<LoadingComponent IsLoading="isLoading" LoadingMessage="جاري تحميل البيانات..." />

@if (!isLoading)
{
    <!-- Enhanced Hero Section -->
    <section class="enhanced-hero-section">
        <div class="syrian-flag-background">
            <div class="flag-stripe flag-green"></div>
            <div class="flag-stripe flag-white">
                <div class="flag-stars">
                    <div class="flag-star"></div>
                    <div class="flag-star"></div>
                    <div class="flag-star"></div>
                </div>
            </div>
            <div class="flag-stripe flag-black"></div>
        </div>
        <!-- Animated Background Elements -->
        <div class="hero-background-elements">
            <div class="floating-element element-1"></div>
            <div class="floating-element element-2"></div>
            <div class="floating-element element-3"></div>
            <div class="floating-element element-4"></div>
        </div>

        <!-- Floating Images with Enhanced Animation -->
@*         <div class="floating-start-box">
            <div class="enhanced-circle-img c1" data-aos="fade-left" data-aos-delay="200">
                <img src="./images/thumbs/11.jpg" alt="صورة المدينة" />
                <div class="image-glow"></div>
            </div>
            <div class="enhanced-circle-img c2" data-aos="fade-left" data-aos-delay="400">
                <img src="./images/thumbs/22.jpg" alt="صورة المدينة" />
                <div class="image-glow"></div>
            </div>
        </div>

        <div class="floating-end-box">
            <div class="enhanced-circle-img c1" data-aos="fade-right" data-aos-delay="300">
                <img src="./images/thumbs/33.jpg" alt="صورة المدينة" />
                <div class="image-glow"></div>
            </div>
            <div class="enhanced-circle-img c2" data-aos="fade-right" data-aos-delay="500">
                <img src="./images/thumbs/44.jpg" alt="صورة المدينة" />
                <div class="image-glow"></div>
            </div>
            <div class="enhanced-circle-img c3" data-aos="fade-right" data-aos-delay="600">
                <img src="./images/thumbs/55.jpg" alt="صورة المدينة" />
                <div class="image-glow"></div>
            </div>
        </div>
 *@
        <!-- Enhanced Content -->
        <div class="enhanced-centerized-box">
            <div class="hero-badge" data-aos="zoom-in">
                <i class="bi bi-heart-fill"></i>
                <span>#اللاذقية_نحن_أهلها</span>
            </div>

            <h1 class="enhanced-hero-title" data-aos="fade-up" data-aos-delay="100">
                <span class="title-line primary-text">اللاذقية</span>
                <span class="title-line secondary-text">نحن أهلها</span>
                <span class="title-line subtitle-text">راجع سجلاتك بسهولة</span>
            </h1>

            <p class="hero-description" data-aos="fade-up" data-aos-delay="200">
                لأن الوطن بحاجة الجميع، و لأن <span class="highlight-text">اللاذقية نحن أهلها</span><br />
                معاً سوياً سنعيد إعمارها ونجعلها أجمل
            </p>

            <div class="hero-actions" data-aos="fade-up" data-aos-delay="300">
                <a class="enhanced-btn primary-btn" href="#search">
                    <i class="bi bi-search"></i>
                    <span>ابدأ البحث</span>
                    <div class="btn-ripple"></div>
                </a>
                <a class="enhanced-btn secondary-btn" href="/projects">
                    <i class="bi bi-grid-3x3-gap"></i>
                    <span>تصفح المشاريع</span>
                    <div class="btn-ripple"></div>
                </a>
                <a class="enhanced-btn tertiary-btn" href="/donations">
                    <i class="bi bi-clipboard-data"></i>
                    <span>سجل التبرعات</span>
                    <div class="btn-ripple"></div>
                </a>
            </div>

            <!-- Stats Section -->
            <div class="hero-stats" data-aos="fade-up" data-aos-delay="400">
                @if (wallets != null && wallets.Any())
                {
                    <div class="stat-item">
                        <div class="stat-number">
                            @wallets.Sum(w => w.Transactions?.Count(t => t.TransactionType == TransactionType.IN) ?? 0)
                        </div>
                        <div class="stat-label">إجمالي التبرعات</div>
                    </div>
                    <div class="stat-divider"></div>
  @*                   <div class="stat-item">
                        <div class="stat-number">@wallets.Sum(w => w.DepositAmount?.Amount ?? 0).ToString("N0")</div>
                        <div class="stat-label">إجمالي المبلغ المودع</div>
                    </div> *@
          @*           <div class="stat-divider"></div> *@
                    <div class="stat-item">
                        <div class="stat-number">@wallets.Count(w => (w.DepositAmount?.Amount ?? 0) > 0)</div>
                        <div class="stat-label">حملات نشطة</div>
                    </div>
                }
            </div>
        </div>

        <!-- Mobile Images Grid -->
@*         <div class="container mb-4 d-md-none d-block" data-aos="fade-up">
            <div class="row mobile-images-grid">
                <div class="col-4">
                    <div class="mobile-image-card">
                        <img src="./images/thumbs/11.jpg" class="w-100" alt="صورة المدينة" />
                        <div class="mobile-image-overlay"></div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="mobile-image-card">
                        <img src="./images/thumbs/33.jpg" class="w-100" alt="صورة المدينة" />
                        <div class="mobile-image-overlay"></div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="mobile-image-card">
                        <img src="./images/thumbs/44.jpg" class="w-100" alt="صورة المدينة" />
                        <div class="mobile-image-overlay"></div>
                    </div>
                </div>
            </div>
        </div> *@

        <!-- Scroll Indicator -->
 
    </section>

    <!-- Enhanced Projects Types Section -->
    <section class="enhanced-projects-section">
        <div class="container">
            <div class="section-header text-center" data-aos="fade-up">
                <div class="section-badge">
                    <i class="bi bi-stars"></i>
                    <span>مشاريعنا</span>
                </div>
                <h2 class="section-title">
                    <span class="primary-text">مشاريع تم تنفيذها</span>
                    <span class="secondary-text">بفضل مساهماتكم</span>
                </h2>
                <p class="section-description">
                    تصفح مشاريعنا المختلفة واكتشف كيف ساهمت تبرعاتكم في تطوير مدينتنا الحبيبة
                </p>
                <div class="section-divider">
                    <span></span>
                    <i class="bi bi-heart-fill"></i>
                    <span></span>
                </div>
            </div>

            <div class="row projects-grid">
                <div class="col-lg-6 mb-4" data-aos="fade-up" data-aos-delay="200">
                    <div class="enhanced-project-card donation-type">
                        <div class="card-background">
                            <div class="bg-pattern pattern-1"></div>
                            <div class="bg-pattern pattern-2"></div>
                        </div>
                        <div class="card-icon donation-icon">
                            <i class="bi bi-heart-fill"></i>
                        </div>
                        <div class="card-content">
                            <h3>مشاريع المساهمات</h3>
                            <p>مشاريع تم تنفيذها من خلال مساهمات المتبرعين الكرام وأهالي المدينة المحبين لها</p>
                            <div class="card-stats">
                                <div class="stat">
                                    <i class="bi bi-check-circle-fill"></i>
                                    <span>مشاريع مكتملة</span>
                                </div>
                                <div class="stat">
                                    <i class="bi bi-people-fill"></i>
                                    <span>بمشاركة المجتمع</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-action">
                            <a href="/donation-projects" class="enhanced-card-btn">
                                <span>تصفح المشاريع</span>
                                <i class="bi bi-arrow-left"></i>
                            </a>
                        </div>
                        <div class="card-hover-effect"></div>
                    </div>
                </div>

                <div class="col-lg-6 mb-4" data-aos="fade-up" data-aos-delay="400">
                    <div class="enhanced-project-card organization-type">
                        <div class="card-background">
                            <div class="bg-pattern pattern-1"></div>
                            <div class="bg-pattern pattern-2"></div>
                        </div>
                        <div class="card-icon organization-icon">
                            <i class="bi bi-building"></i>
                        </div>
                        <div class="card-content">
                            <h3>مشاريع المنظمات</h3>
                            <p>مشاريع منفذة من قبل المنظمات الخيرية والداعمة للمساهمة في تطوير المدينة</p>
                            <div class="card-stats">
                                <div class="stat">
                                    <i class="bi bi-award-fill"></i>
                                    <span>جودة عالية</span>
                                </div>
                                <div class="stat">
                                    <i class="bi bi-shield-check"></i>
                                    <span>موثوقة ومضمونة</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-action">
                            <a href="/organization-projects" class="enhanced-card-btn">
                                <span>تصفح المشاريع</span>
                                <i class="bi bi-arrow-left"></i>
                            </a>
                        </div>
                        <div class="card-hover-effect"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Enhanced Steps Section -->
    <section class="enhanced-steps-section">
        <div class="container">
            <div class="section-header text-center" data-aos="fade-up">
                <div class="section-badge">
                    <i class="bi bi-list-ol"></i>
                    <span>كيف تعمل المنصة</span>
                </div>
                <h2 class="section-title">خطوات بسيطة للمتابعة</h2>
                <p class="section-description">
                    تابع تبرعاتك بسهولة من خلال ثلاث خطوات بسيطة
                </p>
            </div>

            <div class="steps-timeline">
                <div class="row">
                    <div class="col-lg-4 mb-4" data-aos="fade-up" data-aos-delay="200">
                        <div class="enhanced-step-card">
                            <div class="step-number">
                                <span>1</span>
                                <div class="step-pulse"></div>
                            </div>
                            <div class="step-icon">
                                <img src="./images/step1.png" alt="خطوة 1" />
                            </div>
                            <div class="step-content">
                                <h4>احفظ الكود</h4>
                                <p>احفظ الكود بعد التبرع في مكان آمن للرجوع إليه لاحقاً</p>
                            </div>
                            <div class="step-connector"></div>
                        </div>
                    </div>

                    <div class="col-lg-4 mb-4" data-aos="fade-up" data-aos-delay="400">
                        <div class="enhanced-step-card">
                            <div class="step-number">
                                <span>2</span>
                                <div class="step-pulse"></div>
                            </div>
                            <div class="step-icon">
                                <img src="./images/step2.png" alt="خطوة 2" />
                            </div>
                            <div class="step-content">
                                <h4>ادخل الكود</h4>
                                <p>ادخل الكود في أرشيف البحث الخاص بالمنصة</p>
                            </div>
                            <div class="step-connector"></div>
                        </div>
                    </div>

                    <div class="col-lg-4 mb-4" data-aos="fade-up" data-aos-delay="600">
                        <div class="enhanced-step-card">
                            <div class="step-number">
                                <span>3</span>
                                <div class="step-pulse"></div>
                            </div>
                            <div class="step-icon">
                                <img src="./images/step3.png" alt="خطوة 3" />
                            </div>
                            <div class="step-content">
                                <h4>راجع التفاصيل</h4>
                                <p>راجع تفاصيل وسجلات تبرعاتك بشكل مفصل</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Enhanced About Section -->
    <section class="enhanced-about-section" data-aos="fade-up">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6 order-2 order-lg-1" data-aos="fade-right" data-aos-delay="200">
                    <div class="about-content">
                        <div class="section-badge">
                            <i class="bi bi-info-circle"></i>
                            <span>من نحن</span>
                        </div>
                        <h2>مبادرة اللاذقية، نحن أهلها</h2>
                        <div class="content-text">
                            <p>
                                جاءت هذه المبادرة من إيماننا العميق بأن مدينة اللاذقية هي لنا، بعد أن تحررت من عصابات الإجرام.
                                وانطلاقاً من هذا الإيمان وما يترتب عليه من مسؤوليات، قررنا إطلاق هذه المبادرة للنهوض بمدينتنا الجميلة،
                                وإعادة إعمارها، لنستعيد ملامحها الحضارية التي سُلبت منها.
                            </p>
                            <p>
                                تهدف المبادرة إلى توحيد الجهود بين أهالي المدينة الكرام لتنفيذ مشاريع خدمية تعود بالنفع على جميع سكانها،
                                وتسهم في تحسين جودة الحياة واستعادة رونق اللاذقية.
                            </p>
                        </div>
                        <div class="about-features">
                            <div class="feature-item">
                                <i class="bi bi-check-circle-fill"></i>
                                <span>شفافية كاملة</span>
                            </div>
                            <div class="feature-item">
                                <i class="bi bi-people-fill"></i>
                                <span>مشاركة مجتمعية</span>
                            </div>
                            <div class="feature-item">
                                <i class="bi bi-heart-fill"></i>
                                <span>عمل خيري</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6 order-1 order-lg-2" data-aos="fade-left" data-aos-delay="300">
                    <div class="about-image">
                        <div class="image-container">
                            <img src="./images/logo-w.svg" class="main-logo" alt="شعار المبادرة" />
                            <div class="image-decoration">
                                <div class="decoration-circle circle-1"></div>
                                <div class="decoration-circle circle-2"></div>
                                <div class="decoration-circle circle-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Enhanced Search Section -->
    <section id="search" class="enhanced-search-section">
        <div class="container">
            <div class="section-header text-center" data-aos="fade-up">
                <div class="section-badge">
                    <i class="bi bi-search-heart"></i>
                    <span>البحث عن التبرع</span>
                </div>
                <h2 class="section-title">ابحث عن تبرعك</h2>
                <p class="section-description">
                    ادخل كود التبرع للاطلاع على تفاصيل مساهمتك
                </p>
            </div>

            <div class="row align-items-center">
                <div class="col-lg-7" data-aos="fade-left">
                    <div class="enhanced-search-form">
                        <div class="search-input-group">
                            <label class="search-label">
                                <i class="bi bi-key"></i>
                                ادخل كود التبرع:
                            </label>
                            <div class="input-wrapper">
                                <input type="text"
                                       @bind="searchModel.Code"
                                       @onkeypress="@(async (e) => { if (e.Key == "Enter") await SearchDonation(); })"
                                       placeholder="مثال: DON-2024-001"
                                       class="enhanced-search-input"
                                       required />
                                <button type="button"
                                        class="search-btn"
                                        @onclick="SearchDonation"
                                        disabled="@(string.IsNullOrWhiteSpace(searchModel.Code))">
                                    <i class="bi bi-search"></i>
                                    <span>بحث</span>
                                </button>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(searchError))
                        {
                            <div class="search-result error-result" data-aos="fade-in">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                <span>@searchError</span>
                            </div>
                        }

                        @if (showTransactionInfo)
                        {
                            <div class="search-result success-result" data-aos="fade-in">
                                <div class="result-header">
                                    <i class="bi bi-check-circle-fill"></i>
                                    <h4>تم العثور على التبرع</h4>
                                </div>
                                <div class="transaction-details">
                                    <div class="detail-item">
                                        <span class="label">كود المعاملة:</span>
                                        <span class="value">@trx.Code</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">المبلغ:</span>
                                        <span class="value amount">@trx.Amount.ToString("N0") @trx.Currency</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">التاريخ:</span>
                                        <span class="value">@trx.CreatedDate.ToString("yyyy-MM-dd")</span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    @if (wallets != null && wallets.Any(w => w?.DepositAmount?.Amount > 0))
                    {
                        <div class="campaign-info" data-aos="fade-up">
                            <h3>معلومات الحملة</h3>
                            <div class="wallets-grid">
                                @foreach (var wallet in wallets.Where(w => w?.DepositAmount?.Amount > 0))
                                {
                                    <div class="wallet-card">
                                        <div class="wallet-header">
                                            <i class="bi bi-wallet2"></i>
                                            <h4>@wallet.Name</h4>
                                        </div>
                                        <div class="wallet-stats">
                                            <div class="stat-row">
                                                <span class="stat-label">المبلغ المتبقي:</span>
                                                <span class="stat-value primary">@wallet.TotalAmount.Amount.ToString("N0")</span>
                                            </div>
                                            <div class="stat-row">
                                                <span class="stat-label">المبلغ المودع:</span>
                                                <span class="stat-value success">@wallet.DepositAmount.Amount.ToString("N0")</span>
                                            </div>
                                            <div class="stat-row">
                                                <span class="stat-label">المبلغ المسحوب:</span>
                                                <span class="stat-value danger">@wallet.WithdrawalAmount.Amount.ToString("N0")</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <div class="contribute-section" data-aos="fade-up" data-aos-delay="200">
                        <div class="contribute-card">
                            <div class="contribute-header">
                                <i class="bi bi-heart-fill"></i>
                                <h3>شارك معنا للمساهمة</h3>
                            </div>
                            <div class="contribute-content">
                                <p>للمساهمة، يرجى تحويل المبلغ المراد دعم مدينتا الحبيبة به عن طريق البنك المركزي</p>

                                <div class="bank-details">
                                    <div class="bank-section">
                                        <h4>
                                            <i class="bi bi-bank"></i>
                                            حساب التحويل - المصرف المركزي
                                        </h4>
                                        <div class="account-info">
                                            <div class="info-row">
                                                <span class="label">اسم الحساب:</span>
                                                <span class="value">اللاذقية نحن أهلها</span>
                                            </div>
                                            <div class="info-row">
                                                <span class="label">رقم الحساب:</span>
                                                <span class="value account-number">200020600000</span>
                                                <button class="copy-btn" @onclick="@(() => CopyToClipboard("200020600000"))">
                                                    <i class="bi bi-clipboard"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="bank-section">
                                        <h4>
                                            <i class="bi bi-cash-coin"></i>
                                            الإيداع النقدي - البنك المركزي
                                        </h4>
                                        <div class="account-info">
                                            <div class="info-row">
                                                <span class="label">اسم الحساب:</span>
                                                <span class="value">اللاذقية نحن أهلها</span>
                                            </div>
                                            <div class="info-row">
                                                <span class="label">رقم الحساب:</span>
                                                <span class="value account-number">7826761204128816</span>
                                                <button class="copy-btn" @onclick="@(() => CopyToClipboard("7826761204128816"))">
                                                    <i class="bi bi-clipboard"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="important-note">
                                    <i class="bi bi-info-circle-fill"></i>
                                    <p>يرجى التأكد من حصولك على رقم تسلسلي للحوالة بحيث يمكنك تفقد معلومات تبرعك لاحقاً عن طريق منصتنا</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5" data-aos="fade-right">
                    <div class="search-logo">
                        <img src="./images/logo.svg" class="logo" alt="شعار المبادرة" />
                        <div class="logo-glow"></div>
                    </div>
                </div>

    
            </div>
        </div>
    </section>
}

@code {
    private bool isLoading = true;
    private bool showTransactionInfo = false;
    private DonationSearchModel searchModel = new();
    private TransactionDTO trx;
    private WalletDTO wallet;
    private List<WalletDTO> wallets = new();
    private string searchError = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            wallets = await DonationService.GetAllAsync() ?? new List<WalletDTO>();
        }
        catch (Exception ex)
        {
            wallets = new List<WalletDTO>();
        }
        finally
        {
            isLoading = false;
            showTransactionInfo = false;
            StateHasChanged();
        }
    }

    private async Task SearchDonation()
    {
        if (string.IsNullOrWhiteSpace(searchModel.Code))
            return;

        searchError = string.Empty;
        showTransactionInfo = false;

        try
        {
            wallet = await DonationService.GetTransactionByCode(searchModel.Code);
            trx = wallet?.Transactions?.FirstOrDefault();
            if (trx != null)
            {
                showTransactionInfo = true;
            }
            else
            {
                searchError = "لم يتم العثور على معاملة بهذا الكود. تأكد من صحة الكود المدخل.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error searching for donation: {ex.Message}");
            searchError = "حدث خطأ أثناء البحث. يرجى المحاولة لاحقاً أو التواصل مع فريق الدعم.";
        }
    }

    private async Task CopyToClipboard(string text)
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
        // Optionally, show a visual feedback here if needed
    }

    public class DonationSearchModel
    {
        public string Code { get; set; } = "";
    }
}